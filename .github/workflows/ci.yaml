name: CI


on:
  workflow_dispatch: 


# jobs:
  # frontend:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: ./app/frontend
  #   strategy:
  #     matrix:
  #       node-version: [18.x]
  #   steps:
  #     - name: Check-out git repository  
  #       uses: actions/checkout@v4

  #     - name: USE NODEJS ${{ matrix.node-version }}
  #       uses: actions/setup-node@v4

  #     - name: Install project dependencies 
  #       working-directory: ./app/frontend
  #       run: |
  #         npm i
  #         npm run lint
  #         npm install --save-dev --save-exact prettier
  #         npm run prettier
  #         npm test
  #       env:
  #         CI: true 

  #     - name: Build
  #       run: npm run build
  #       working-directory: ./app/frontend

              # Setup sonar-scanner
      # - name: Setup SonarQube
      #   uses: warchant/setup-sonar-scanner@v8

      # - name: Analyze with SonarCloud
      #   uses: sonarsource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     projectBaseDir: quiz-app
      #     args: >
      #       -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
      #       -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
      #       -Dsonar.host.url=${{ secrets.SONAR_URL }}
      #       -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      #       -Dsonar.sources=src/
      #       -Dsonar.verbose=true

# TU JEST OK
  # backend:

  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: ./app/backend
  #   strategy:
  #     matrix:
  #       python-version: ["3.10"]

  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #     # You can test your matrix by printing the current Python version
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #         pythom -m pytest
jobs:          
  build_and_deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app/backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t cvapp-web:latest .    

      - name: Tag Docker image
        run: |
          docker tag cvapp-web:latest michalziaja/cvapp-web:${{ github.run_number }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push image to Docker Hub
        run: |
          docker push michalziaja/cvapp-web:${{ github.run_number }}

  update_deploy:
    name: Update k8s deployment file
    runs-on: ubuntu-latest
    needs: build_and_deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git config
        run: |
          git config --global user.email "michalziaja88@gmail.com"
          git config --global user.name "michalziaja"

      - name: Update deployment file
        run: |
          sed -i 's|image: michalziaja/cvapp-api.*|image: michalziaja/cvapp-api:${{ github.run_number }}|' kubernetes/cvapp-api.yaml
          git add kubernetes/cvapp-api.yaml
          git commit -m "Update image to tag ${{ github.run_number }}"
          git push origin main
  #   defaults:
    
  #     run:
  #       working-directory: ./kubernetes
  #   steps:
  #     - name: Update deployment file
  #       run: |
  #         sed -i 's|image: michalziaja/cvapp-web:|image: michalziaja/cvapp-web:${{ github.run_number }}|' cvapp-web.yaml

    # - name: Switch to staging cluster
    #   run: kubectl config use-context staging

        